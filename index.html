<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>VietinBank 2/9 ASCII Countdown</title>
  <style>
    html,body{
      margin:0;height:100dvh;width:100vw;background:#000;display:grid;place-items:center;overflow:hidden;
      font-family:ui-monospace,monospace;color:#fff;
    }
    #stage{position:fixed;inset:0;width:100vw;height:100dvh}

    /* ASCII area */
    #asciiWrap{position:fixed;inset:0;display:none;place-items:center;z-index:10;overflow:hidden;background:#000}
    #out{white-space:pre;margin:0;padding:0;font-weight:800;letter-spacing:-.02em;opacity:1;transition:opacity 280ms ease}

    /* Countdown */
    #countdownWrap{position:fixed;inset:0;display:none;place-items:center;background:#000;z-index:30}
    #countdown{
      font-size:min(22vw,200px);font-weight:900;letter-spacing:.08em;color:#fff;
      text-shadow:0 0 28px rgba(255,255,255,.6),0 0 60px rgba(255,255,255,.35);
      animation:pulse 1.1s ease both
    }
    @keyframes pulse{0%{transform:scale(.6);filter:blur(6px);opacity:.5}60%{transform:scale(1.12);opacity:1}100%{transform:scale(1)}}

    /* Intro slides (ảnh nền) */
    #textSlide{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;text-align:center;z-index:20;overflow:hidden}
    #slideBg{position:absolute;inset:0;background-position:center;background-size:cover}
    #slideOverlay{position:absolute;inset:0;opacity:.6;mix-blend-mode:overlay}
    #slideText{
      position:relative;margin:0 4vw;font-family:"Times New Roman",serif;font-weight:900;
      font-size:min(14vw,84px);letter-spacing:.04em;color:#fff;
      animation:zoomIn 900ms cubic-bezier(.2,.75,.25,1) both
    }
    @keyframes zoomIn{0%{transform:scale(.72);opacity:0}55%{transform:scale(1.06);opacity:1}100%{transform:scale(1)}}

    /* Fullscreen + Unmute prompts */
    #fsBtn{
      position:fixed;right:10px;top:10px;z-index:40;display:none;
      padding:8px 12px;border-radius:8px;border:none;background:rgba(0,0,0,.6);color:#fff;font-weight:700
    }
    #unmute{
      position:fixed;inset:0;display:none;place-items:center;z-index:50;background:rgba(0,0,0,.65)
    }
    #unmute button{
      font-weight:800;padding:10px 16px;border-radius:10px;border:none;background:#1e88e5;color:#fff
    }

    video,canvas,audio{display:none}
  </style>
</head>
<body>
<div id="stage">
  <!-- Countdown -->
  <div id="countdownWrap"><div id="countdown"></div></div>

  <!-- Intro slides -->
  <div id="textSlide">
    <div id="slideBg"></div>
    <div id="slideOverlay"></div>
    <h1 id="slideText"></h1>
  </div>

  <!-- ASCII -->
  <div id="asciiWrap"><pre id="out"></pre></div>

  <!-- Fullscreen (optional) -->
  <button id="fsBtn">Toàn màn hình</button>

  <!-- Unmute gate (khi trình duyệt chặn âm thanh) -->
  <div id="unmute"><button id="btnUnmute">Bật âm thanh</button></div>
</div>

<!-- Media -->
<video id="v" playsinline crossorigin="anonymous"
 src="https://res.cloudinary.com/dj5uo6y8w/video/upload/v1756374279/bac-ho-2-9_pllr7b.mp4"></video>
<audio id="bgm" loop crossorigin="anonymous"
 src="https://res.cloudinary.com/dj5uo6y8w/video/upload/v1756622154/M%C3%A1u_%C4%90%E1%BB%8F_Da_V%C3%A0ng_mp3cut.net_vhw8k0.mp3"></audio>

<canvas id="c"></canvas>
<canvas id="tc"></canvas>

<script>
/* ==== DOM ==== */
const v = document.getElementById('v');
const bgm = document.getElementById('bgm');
const c = document.getElementById('c');
const ctx = c.getContext('2d', { willReadFrequently: true });
const tc = document.getElementById('tc');
const tctx = tc.getContext('2d', { willReadFrequently: true });

const asciiWrap = document.getElementById('asciiWrap');
const out = document.getElementById('out');
const countdownWrap = document.getElementById('countdownWrap');
const countdown = document.getElementById('countdown');
const textSlide = document.getElementById('textSlide');
const slideBg = document.getElementById('slideBg');
const slideOverlay = document.getElementById('slideOverlay');
const slideText = document.getElementById('slideText');
const fsBtn = document.getElementById('fsBtn');
const unmute = document.getElementById('unmute');
const btnUnmute = document.getElementById('btnUnmute');

/* ==== CONFIG ==== */
const gradientChars = "  .`:,;clloooodddxxkkkOO00KKXXNNWW";
let asciiRows = 0, COLORIZE_VIDEO = true;

const FLAG_IMG_SRC = "https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436052/hinh-nen-co-viet-nam-cho-may-tinh-1_hlcqkj.jpg";
let flagImg = new Image(), flagReady = false;
flagImg.crossOrigin = "anonymous";
flagImg.onload = ()=> flagReady = true;
flagImg.src = FLAG_IMG_SRC;

/* Utils */
function vw(){ return window.innerWidth }
function vh(){ return window.innerHeight }
function getCols(){
  const w = vw();
  if (w <= 640) return 120;
  if (w <= 820) return 150;
  if (w <= 1024) return 170;
  if (w <= 1366) return 200;
  return 230;
}
function lum(r,g,b){ return (0.299*r + 0.587*g + 0.114*b)/255; }

/* Fit + Cover để luôn FULL màn hình */
function setAsciiSize(){
  if(asciiRows===0) return;
  const cols = getCols();
  const fsW = vw() / cols;
  const fsH = vh() / asciiRows;
  const baseFS = Math.min(fsW, fsH);
  const baseW = cols * baseFS;
  const baseH = asciiRows * baseFS;
  const scale = Math.max(vw()/baseW, vh()/baseH);
  out.style.fontSize = baseFS + "px";
  out.style.lineHeight = baseFS + "px";
  out.style.transform = `scale(${scale})`;
}

/* ===== VIDEO → ASCII ===== */
function toAsciiFrameGradient_Video(){
  if(!v.videoWidth) return "";
  const cols = getCols();
  const targetW = cols;
  const targetH = Math.max(1, Math.round((v.videoHeight / v.videoWidth) * targetW * 0.55));
  c.width = targetW; c.height = targetH;
  ctx.drawImage(v, 0, 0, targetW, targetH);

  const data = ctx.getImageData(0,0,targetW,targetH).data;
  asciiRows = targetH;
  const maxIdx = gradientChars.length - 1;
  let html = "";

  for(let y=0;y<targetH;y++){
    for(let x=0;x<targetW;x++){
      const i=(y*targetW+x)*4;
      const r=data[i], g=data[i+1], b=data[i+2];
      const L=lum(r,g,b);
      const idx=Math.max(0, Math.min(maxIdx, Math.round(L*maxIdx)));
      const ch=gradientChars[idx];
      html += COLORIZE_VIDEO ? `<span style="color:rgb(${r},${g},${b})">${ch}</span>` : ch;
    }
    html += "\n";
  }
  return html;
}

/* ====== WRAP multi-line cho ASCII TEXT ====== */
function wrapLinesByWidth(text, maxWidthPx, font){
  tctx.font = font;
  const words = text.split(/\s+/);
  const lines = [];
  let cur = "";
  for(const w of words){
    const test = cur ? cur + " " + w : w;
    if(tctx.measureText(test).width <= maxWidthPx) cur = test;
    else { if(cur) lines.push(cur); cur = w; }
  }
  if(cur) lines.push(cur);
  return lines;
}

/* đảm bảo chiều cao cũng fit: giảm font nếu vượt */
function fitFontAndWrap(text, targetW, targetH){
  let fs = Math.max(14, Math.round(targetH * 0.42));
  let font = `900 ${fs}px "Times New Roman", serif`;
  let lines = wrapLinesByWidth(text, targetW*0.9, font);
  // nếu >2 dòng hoặc tổng chiều cao quá lớn -> giảm font tiếp
  function totalH(fsize, lineCount){ return lineCount * fsize * 1.1; }
  while ((lines.length > 2 || totalH(fs, lines.length) > targetH*0.88) && fs > 10){
    fs -= 2;
    font = `900 ${fs}px "Times New Roman", serif`;
    lines = wrapLinesByWidth(text, targetW*0.9, font);
  }
  return { fs, font, lines };
}

/* ====== SLIDE (Ảnh cờ + chữ) → ASCII (fade in/out + zoom) ====== */
function drawFlagAndTextASCII(text, t, duration, slideIndex){
  const cols = getCols();
  tc.width = cols;
  tc.height = Math.max(28, Math.round(cols * 0.30));
  const W = tc.width, H = tc.height;

  // vẽ cờ cover
  tctx.clearRect(0,0,W,H);
  if(flagReady){
    let ratio = flagImg.width/flagImg.height || 1.6;
    let dw = W, dh = W/ratio;
    if(dh < H){ dh = H; dw = dh*ratio; }
    const dx = (W - dw)/2, dy = (H - dh)/2;
    tctx.drawImage(flagImg, dx, dy, dw, dh);
  }

  // tính font + wrap
  let {fs, font, lines} = fitFontAndWrap(text, W, H);
  tctx.font = font;
  tctx.textAlign = 'center';
  tctx.textBaseline = 'middle';

  // hiệu ứng zoom
  const p = Math.max(0, Math.min(1, t/duration));
  const scale = 0.92 + 0.08*Math.sin(p*Math.PI);
  tctx.save();
  tctx.translate(W/2, H/2);
  tctx.scale(scale, scale);

  // vẽ từng dòng, slide 7 tô “Việt Nam” đỏ
  function drawRuns(line, y, baseColor){
    tctx.lineWidth = Math.max(2, fs*0.08);
    tctx.strokeStyle = 'rgba(0,0,0,0.85)';
    const isSpecial7 = (slideIndex === 6) && line.includes('Việt Nam');
    if(!isSpecial7){
      tctx.strokeText(line, 0, y);
      tctx.fillStyle = baseColor;
      tctx.fillText(line, 0, y);
      return;
    }
    const parts = line.split('Việt Nam');
    const widths = parts.map(p => tctx.measureText(p).width);
    const vnW = tctx.measureText('Việt Nam').width;
    const totalW = widths[0] + vnW + (parts[1] ? widths[1] : 0);
    let cursor = -totalW/2;

    // trái
    if(parts[0]){
      tctx.strokeText(parts[0], cursor + widths[0]/2, y);
      tctx.fillStyle = baseColor;
      tctx.fillText(parts[0], cursor + widths[0]/2, y);
      cursor += widths[0];
    }
    // Việt Nam (đỏ)
    tctx.strokeText('Việt Nam', cursor + vnW/2, y);
    tctx.fillStyle = '#ff1a1a';
    tctx.fillText('Việt Nam', cursor + vnW/2, y);
    cursor += vnW;

    // phải
    if(parts[1]){
      tctx.strokeText(parts[1], cursor + widths[1]/2, y);
      tctx.fillStyle = baseColor;
      tctx.fillText(parts[1], cursor + widths[1]/2, y);
    }
  }

  const baseColor = '#ffffff';
  const totalH = lines.length * fs * 1.1;
  let y0 = -totalH/2 + fs*0.5;
  for(const line of lines){
    drawRuns(line, y0, baseColor);
    y0 += fs*1.1;
  }

  tctx.restore();

  // convert canvas → ASCII spans
  const data = tctx.getImageData(0,0,W,H).data;
  asciiRows = H;
  let html = "";
  const maxIdx = gradientChars.length - 1;
  for(let yy=0; yy<H; yy++){
    for(let xx=0; xx<W; xx++){
      const i = (yy*W + xx)*4, a = data[i+3];
      if(a < 20){ html += ' '; continue; }
      const r=data[i], g=data[i+1], b=data[i+2];
      const L = lum(r,g,b);
      const idx = Math.max(0, Math.min(maxIdx, Math.round(L*maxIdx)));
      const ch = gradientChars[idx] || ' ';
      html += `<span style="color:rgb(${r},${g},${b})">${ch}</span>`;
    }
    html += "\n";
  }
  return html;
}

/* ===== FLOW: VIDEO → SLIDES (một lần, có âm thanh) ===== */
function playAsciiVideoThenSlides(){
  asciiWrap.style.display = "grid";
  setAsciiSize();

  // thử phát video có âm thanh
  v.muted = false; v.volume = 1;
  v.play().then(()=>{
    // OK, có tiếng
    unmute.style.display = 'none';
    startVideoLoop();
  }).catch(()=>{
    // Trình duyệt chặn -> phát mute + hiện nút bật âm thanh
    v.muted = true;
    v.play().then(()=>{
      unmute.style.display = 'grid';
      startVideoLoop();
    }).catch(err=>console.error("Không thể phát video:", err));
  });

  btnUnmute.onclick = ()=>{
    v.muted = false;
    v.play().catch(()=>{});
    bgm.play().catch(()=>{});
    unmute.style.display = 'none';
  };

  function startVideoLoop(){
    let done = false;
    function loop(){
      if(v.ended || v.paused){
        if(!done){
          done = true;
          startFlagSlides();
        }
        return;
      }
      out.innerHTML = toAsciiFrameGradient_Video();
      setAsciiSize();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  }
}

/* ===== SLIDES LIST ===== */
const asciiSlides = [
  "Tự hào màu cờ sắc áo",
  "VietinBank đồng hành",
  "cùng Tổ quốc vươn xa –",
  "giữ vững niềm tin, lan",
  "tỏa khát vọng, chung tay",
  "dựng xây đất nước phồn",
  "vinh, vì một Việt Nam",
  "ngày càng thịnh vượng, văn",
  "minh và tỏa sáng trên",
  "trường quốc tế."
];

/* ===== ASCII SLIDES: fade in/out + zoom, auto-wrap, autoscale ===== */
function startFlagSlides(){
  // bật nhạc (nếu đang bị chặn sẽ theo nút Unmute)
  bgm.volume = 1;
  bgm.play().catch(()=>{ /* sẽ được bật cùng nút Unmute */ });

  let idx = 0;
  const D = 2000;       // mỗi slide 2s
  const GAP = 220;      // trễ giữa slide
  function playOne(){
    if(idx >= asciiSlides.length){ return; }
    const text = asciiSlides[idx++];
    const t0 = performance.now();
    function loop(){
      const t = performance.now() - t0;
      const p = Math.max(0, Math.min(1, t / D));

      // fade in/out qua opacity của #out
      // 0→0.15: fade in, 0.85→1: fade out
      let op = 1;
      if(p < 0.15) op = p / 0.15;
      else if(p > 0.85) op = (1 - p) / 0.15;
      out.style.opacity = Math.max(0, Math.min(1, op));

      out.innerHTML = drawFlagAndTextASCII(text, t, D, idx-1);
      setAsciiSize();

      if(t < D){ requestAnimationFrame(loop); }
      else { out.style.opacity = 0; setTimeout(playOne, GAP); }
    }
    out.style.opacity = 0; // bắt đầu từ mờ để fade in
    requestAnimationFrame(loop);
  }
  playOne();
}

/* ===== COUNTDOWN & INTRO SLIDES ===== */
function runCountdown(next){
  const steps=["3","2","1"]; let i=0;
  countdownWrap.style.display='grid';
  const tick=()=>{
    if(i<steps.length){
      countdown.textContent=steps[i++];
      countdown.style.animation='none'; void countdown.offsetWidth;
      countdown.style.animation='pulse 1.1s ease both';
      setTimeout(tick, 1100);
    }else{
      countdownWrap.style.display='none';
      next && next();
    }
  }; tick();
}

const BG_BLUE="https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436137/3654dadd-589c-49de-8241-1748d8ef4a69_yx4mjg.webp";
const BG_FLAG="https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436056/hinh-nen-co-viet-nam-cho-may-tinh-1_wwoocv.jpg";

function showSlides(slides, done){
  let idx=0;
  textSlide.style.opacity = 0;
  textSlide.style.transition = 'opacity 350ms ease';
  const showOne=()=>{
    if(idx>=slides.length){
      textSlide.style.display='none';
      done && done();
      return;
    }
    const s = slides[idx++];
    slideBg.style.backgroundImage = `url('${s.bgImage}')`;
    slideOverlay.style.background = s.overlay;
    slideText.textContent = s.text;
    slideText.style.color = s.color;

    textSlide.style.display = 'flex';
    requestAnimationFrame(()=> textSlide.style.opacity = 1);
    setTimeout(()=>{
      // fade out trước khi chuyển slide
      textSlide.style.opacity = 0;
      setTimeout(showOne, 220);
    }, s.duration);
  };
  showOne();
}

/* ===== FULLSCREEN (tuỳ chọn) ===== */
function isFullscreen(){ return !!(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement); }
function enterFullscreen(el){ const req = el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen; if(req) req.call(el); }
fsBtn.addEventListener('click', ()=> enterFullscreen(document.documentElement));
document.addEventListener('fullscreenchange', ()=> fsBtn.style.display = isFullscreen()? 'none' : 'block');
document.addEventListener('webkitfullscreenchange', ()=> fsBtn.style.display = isFullscreen()? 'none' : 'block');

/* ===== START ===== */
function startAll(){
  // hiện nút fullscreen khi ngang (tuỳ chọn)
  fsBtn.style.display = 'block';

  const slides = [
    { text: "PHÒNG DỊCH VỤ KHÁCH HÀNG", bgImage: BG_BLUE, overlay: "linear-gradient(180deg, rgba(0,114,188,.55), rgba(0,114,188,.55))", color: "#ffffff", duration: 1800 },
    { text: "VIETINBANK",                 bgImage: BG_BLUE, overlay: "linear-gradient(180deg, rgba(0,114,188,.55), rgba(0,114,188,.55))", color: "#ffffff", duration: 1600 },
    { text: "CHI NHÁNH BẢO LỘC",          bgImage: BG_BLUE, overlay: "linear-gradient(180deg, rgba(0,114,188,.55), rgba(0,114,188,.55))", color: "#ffffff", duration: 2000 },
    { text: "CHÚC MỪNG",                  bgImage: BG_FLAG, overlay: "linear-gradient(180deg, rgba(218,37,29,.45), rgba(218,37,29,.45))", color: "#ff1a1a", duration: 1600 },
    { text: "ĐẠI LỄ 2/9",                 bgImage: BG_FLAG, overlay: "linear-gradient(180deg, rgba(218,37,29,.45), rgba(218,37,29,.45))", color: "#ff1a1a", duration: 2200 },
  ];
  runCountdown(()=> showSlides(slides, ()=> {
    asciiWrap.style.display='grid';
    playAsciiVideoThenSlides();
  }));
}

window.addEventListener('resize', setAsciiSize);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setAsciiSize(); });

window.addEventListener('load', startAll);
</script>
</body>
</html>
