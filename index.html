<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>VietinBank 2/9 ASCII Countdown</title>
  <style>
    :root{ --blue:#0072bc; --red:#da251d; --yellow:#ffeb3b; }
    *{box-sizing:border-box}
    html,body{height:100%;-webkit-text-size-adjust:none;text-size-adjust:none}
    body{
      margin:0;height:100%;display:grid;place-items:center;background:#000;color:#eaeaea;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      overflow:hidden;
    }

    /* Countdown */
    #countdownWrap{
      position:fixed;inset:0;display:none;place-items:center;background:#000;z-index:20
    }
    #countdown{
      font-size:min(22vw,200px);font-weight:900;color:#fff;letter-spacing:.08em;
      text-shadow:0 0 28px rgba(255,255,255,.6),0 0 60px rgba(255,255,255,.35);
      animation:pulse 1.1s ease both
    }
    @keyframes pulse{
      0%{transform:scale(.6);filter:blur(6px);opacity:.5}
      60%{transform:scale(1.12);filter:blur(0);opacity:1}
      100%{transform:scale(1)}
    }

    /* Slides */
    #textSlide{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;text-align:center;z-index:15;overflow:hidden
    }
    #slideBg{
      position:absolute;inset:0;background-position:center;background-size:cover;background-repeat:no-repeat;
      transform:scale(1.06);filter:brightness(.95) saturate(1.05);
    }
    #slideOverlay{position:absolute;inset:0;pointer-events:none;opacity:.85;mix-blend-mode:overlay;background:transparent;}
    #slideText{
      position:relative;margin:0 4vw;line-height:1.05;text-align:center;
      font-family:"Times New Roman", Times, serif;font-weight:900;
      font-size:min(14vw,84px);letter-spacing:.04em;
      animation:zoomIn 900ms cubic-bezier(.2,.75,.25,1) both, glow 1400ms ease-in-out infinite alternate;
      filter:drop-shadow(0 2px 12px rgba(0,0,0,.35));
    }
    @keyframes zoomIn{
      0%{transform:scale(.72);filter:blur(7px);opacity:0}
      55%{transform:scale(1.06);filter:blur(0);opacity:1}
      100%{transform:scale(1)}
    }
    @keyframes glow{
      0%{text-shadow:0 0 12px rgba(255,255,255,.28)}
      100%{text-shadow:0 0 20px rgba(255,255,255,.48)}
    }

    /* ASCII area */
    #asciiWrap{position:fixed;inset:0;display:none;place-items:center;z-index:10;overflow:hidden;}
    #out{
      white-space:pre;margin:0;padding:0;background:#000;
      transform-origin:center center;will-change:transform,font-size,line-height;
      font-weight:700; letter-spacing:-.02em;
    }

    video,canvas{display:none}
  </style>
</head>
<body>

  <!-- Countdown -->
  <div id="countdownWrap"><div id="countdown"></div></div>

  <!-- Slides -->
  <div id="textSlide">
    <div id="slideBg"></div>
    <div id="slideOverlay"></div>
    <h1 id="slideText"></h1>
  </div>

  <!-- ASCII -->
  <div id="asciiWrap"><pre id="out"></pre></div>

  <!-- Video -->
  <video id="v" playsinline crossorigin="anonymous"
         src="https://res.cloudinary.com/dj5uo6y8w/video/upload/v1756374279/bac-ho-2-9_pllr7b.mp4"></video>
  <canvas id="c"></canvas>

<script>
/* ==== DOM ==== */
const v = document.getElementById('v');
const c = document.getElementById('c');
const ctx = c.getContext('2d', { willReadFrequently: true });
const asciiWrap = document.getElementById('asciiWrap');
const out = document.getElementById('out');
const countdownWrap = document.getElementById('countdownWrap');
const countdown = document.getElementById('countdown');
const textSlide = document.getElementById('textSlide');
const slideBg = document.getElementById('slideBg');
const slideOverlay = document.getElementById('slideOverlay');
const slideText = document.getElementById('slideText');

/* ==== CONFIG (Gradient ASCII) ==== */
/* Ký tự theo kiểu bạn gửi: nhiều chữ c, l, o, d, x, k, 0… */
const gradientChars = "  .`:,;clloooodddxxkkkOO00KKXXNNWW";
const COLORIZE = true;  // tô màu như video; đặt false nếu muốn đơn sắc (nhẹ CPU)

let asciiRows = 0;
function getCols(){ return window.innerWidth < 768 ? 100 : 180; } // chỉnh để mịn hơn
function lum(r,g,b){ return (0.299*r + 0.587*g + 0.114*b)/255; }

/* Trả về 1 khung ASCII dạng gradient (có/không màu) */
function toAsciiFrameGradient(){
  if(!v.videoWidth) return "";
  const cols = getCols();

  // ước lượng tỉ lệ glyph monospace ~ 0.5 (rộng/cao), nên scale chiều cao cho cân
  const charW = 0.55, charH = 1.0; // có thể tinh chỉnh
  const targetW = cols;
  const targetH = Math.max(1, Math.round((v.videoHeight / v.videoWidth) * targetW * (charW / charH)));

  c.width = targetW;
  c.height = targetH;
  ctx.drawImage(v, 0, 0, targetW, targetH);

  const data = ctx.getImageData(0,0,targetW,targetH).data;
  asciiRows = targetH;

  const maxIdx = gradientChars.length - 1;
  let html = ""; // dùng innerHTML để thêm màu theo pixel

  for(let y=0;y<targetH;y++){
    for(let x=0;x<targetW;x++){
      const i = (y*targetW + x) * 4;
      const r = data[i], g = data[i+1], b = data[i+2];

      // độ sáng 0..1
      const L = lum(r,g,b);
      const idx = Math.max(0, Math.min(maxIdx, Math.round(L * maxIdx)));
      const ch = gradientChars[idx];

      if(COLORIZE){
        html += `<span style="color:rgb(${r},${g},${b})">${ch}</span>`;
      }else{
        html += ch;
      }
    }
    html += "\n";
  }
  return html;
}

/* Fit + Cover để căng full màn hình */
function setAsciiSize(){
  if(asciiRows===0) return;
  const cols = getCols();
  const fsW = window.innerWidth / cols;
  const fsH = window.innerHeight / asciiRows;
  const baseFS = Math.min(fsW, fsH);
  const baseWidth = cols * baseFS;
  const baseHeight = asciiRows * baseFS;
  const scale = Math.max(window.innerWidth/baseWidth, window.innerHeight/baseHeight);
  out.style.fontSize = baseFS + "px";
  out.style.lineHeight = baseFS + "px";
  out.style.transform = `scale(${scale})`;
}

/* Loop phát */
function playAscii(){
  asciiWrap.style.display='grid';
  setAsciiSize();

  function loop(){
    if(v.paused || v.ended) return;
    out.innerHTML = toAsciiFrameGradient();
    requestAnimationFrame(loop);
  }

  // Autoplay + fallback
  v.muted = false; v.volume = 1;
  v.play().then(()=>{ loop(); }).catch(()=>{
    v.muted = true;
    v.play().then(()=>{
      loop();
      const oneTapUnmute = () => {
        v.muted = false;
        v.play().catch(()=>{});
        document.removeEventListener('pointerdown', oneTapUnmute, {capture:true});
      };
      document.addEventListener('pointerdown', oneTapUnmute, {once:true, capture:true});
    }).catch(err=>console.error("Không thể phát video:", err));
  });
}

/* ==== Intro (giữ nguyên) ==== */
function runCountdown(next){
  const steps=["3","2","1"]; let i=0;
  countdownWrap.style.display='grid';
  const tick=()=>{
    if(i<steps.length){
      countdown.textContent = steps[i++];
      countdown.style.animation='none'; void countdown.offsetWidth;
      countdown.style.animation='pulse 1.1s ease both';
      setTimeout(tick, 1100);
    }else{
      countdownWrap.style.display='none';
      next && next();
    }
  };
  tick();
}

const BG_BLUE = "https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436137/3654dadd-589c-49de-8241-1748d8ef4a69_yx4mjg.webp";
const BG_FLAG = "https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436056/hinh-nen-co-viet-nam-cho-may-tinh-1_wwoocv.jpg";

function showSlides(slides, done){
  let idx=0;
  const showOne=()=>{
    if(idx>=slides.length){
      textSlide.style.display='none';
      done && done();
      return;
    }
    const s = slides[idx++];

    slideBg.style.backgroundImage = `url('${s.bgImage}')`;
    slideOverlay.style.background = s.overlay;
    slideText.textContent = s.text;
    slideText.style.color = s.color;

    slideText.style.animation='none'; void slideText.offsetHeight;
    slideText.style.animation='zoomIn 900ms cubic-bezier(.2,.75,.25,1) both, glow 1400ms ease-in-out infinite alternate';

    textSlide.style.display='flex';
    setTimeout(showOne, s.duration);
  };
  showOne();
}

/* ==== Start chain ==== */
function startAll(){
  if(screen.orientation && screen.orientation.lock){
    screen.orientation.lock('landscape').catch(()=>{});
  }
  runCountdown(()=>{
    const slides = [
      { text: "PHÒNG DỊCH VỤ KHÁCH HÀNG", bgImage: BG_BLUE, overlay: "linear-gradient(180deg, rgba(0,114,188,.55), rgba(0,114,188,.55))", color: "#ffffff", duration: 1800 },
      { text: "VIETINBANK",                 bgImage: BG_BLUE, overlay: "linear-gradient(180deg, rgba(0,114,188,.55), rgba(0,114,188,.55))", color: "#ffffff", duration: 1600 },
      { text: "CHI NHÁNH BẢO LỘC",          bgImage: BG_BLUE, overlay: "linear-gradient(180deg, rgba(0,114,188,.55), rgba(0,114,188,.55))", color: "#ffffff", duration: 2000 },
      { text: "CHÚC MỪNG",                  bgImage: BG_FLAG, overlay: "linear-gradient(180deg, rgba(218,37,29,.45), rgba(218,37,29,.45))", color: "#ff1a1a", duration: 1600 },
      { text: "ĐẠI LỄ 2/9",                 bgImage: BG_FLAG, overlay: "linear-gradient(180deg, rgba(218,37,29,.45), rgba(218,37,29,.45))", color: "#ff1a1a", duration: 2200 },
    ];

    slideText.style.textShadow = "0 0 18px rgba(255,232,107,.75), 0 0 36px rgba(255,232,107,.45), 0 2px 12px rgba(0,0,0,.45)";
    showSlides(slides, ()=> playAscii());
  });
}

/* ==== Events ==== */
v.addEventListener('loadedmetadata', setAsciiSize);
window.addEventListener('resize', setAsciiSize);
if(screen.orientation && screen.orientation.addEventListener){
  screen.orientation.addEventListener('change', ()=> setTimeout(setAsciiSize, 80));
}
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setAsciiSize(); });

window.addEventListener('load', startAll);
</script>
</body>
</html>
