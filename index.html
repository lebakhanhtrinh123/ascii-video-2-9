<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>VietinBank 2/9 ASCII Countdown</title>
  <style>
    html,body{
      margin:0;height:100dvh;width:100vw;background:#000;display:grid;place-items:center;overflow:hidden;
      font-family:ui-monospace,monospace;color:#fff;
    }
    #stage{position:fixed;inset:0;width:100vw;height:100dvh}

    /* ASCII area */
    #asciiWrap{position:fixed;inset:0;display:none;place-items:center;z-index:10;overflow:hidden;background:#000}
    #out{
      white-space:pre;margin:0;padding:0;font-weight:800;letter-spacing:-.02em;
      opacity:1;transition:opacity 220ms ease;
      /* Cho màn dọc: mềm hơn một chút để chữ “khít” hơn */
      word-break:normal
    }

    /* Countdown */
    #countdownWrap{position:fixed;inset:0;display:none;place-items:center;background:#000;z-index:30}
    #countdown{
      font-size:min(22vw,200px);font-weight:900;letter-spacing:.08em;color:#fff;
      text-shadow:0 0 28px rgba(255,255,255,.6),0 0 60px rgba(255,255,255,.35);
      animation:pulse 1.1s ease both
    }
    @keyframes pulse{0%{transform:scale(.6);filter:blur(6px);opacity:.5}60%{transform:scale(1.12);opacity:1}100%{transform:scale(1)}}

    /* Intro slides (ảnh nền) */
    #textSlide{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;text-align:center;z-index:20;overflow:hidden}
    #slideBg{position:absolute;inset:0;background-position:center;background-size:cover}
    #slideOverlay{position:absolute;inset:0;opacity:.6;mix-blend-mode:overlay}
    #slideText{
      position:relative;margin:0 4vw;font-family:"Times New Roman",serif;font-weight:900;
      font-size:min(14vw,84px);letter-spacing:.04em;color:#fff;
      animation:zoomIn 900ms cubic-bezier(.2,.75,.25,1) both
    }
    @keyframes zoomIn{0%{transform:scale(.72);opacity:0}55%{transform:scale(1.06);opacity:1}100%{transform:scale(1)}}

    /* Fullscreen + Unmute prompts */
    #fsBtn{
      position:fixed;right:10px;top:10px;z-index:40;display:none;
      padding:8px 12px;border-radius:8px;border:none;background:rgba(0,0,0,.6);color:#fff;font-weight:700
    }
    #unmute{
      position:fixed;inset:0;display:none;place-items:center;z-index:50;background:rgba(0,0,0,.65)
    }
    #unmute button{
      font-weight:800;padding:10px 16px;border-radius:10px;border:none;background:#1e88e5;color:#fff
    }

    /* Banner gợi ý mở ngoài (KHÔNG chặn phát) */
    #openExternal{
      position:fixed;left:50%;transform:translateX(-50%);bottom:10px;z-index:9999;
      display:none;background:#111;color:#fff;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.45)
    }
    #openExternal button{
      margin-left:8px;padding:8px 12px;border:none;border-radius:10px;font-weight:800;cursor:pointer;background:#1e88e5;color:#fff
    }

    video,canvas,audio{display:none}
  </style>
</head>
<body>
<div id="stage">
  <!-- Countdown -->
  <div id="countdownWrap"><div id="countdown"></div></div>

  <!-- Intro slides -->
  <div id="textSlide">
    <div id="slideBg"></div>
    <div id="slideOverlay"></div>
    <h1 id="slideText"></h1>
  </div>

  <!-- ASCII -->
  <div id="asciiWrap"><pre id="out"></pre></div>

  <!-- Fullscreen (optional) -->
  <button id="fsBtn">Toàn màn hình</button>

  <!-- Unmute gate -->
  <div id="unmute"><button id="btnUnmute">Bật âm thanh</button></div>
</div>

<!-- Gợi ý mở bằng trình duyệt -->
<div id="openExternal">
  Mở bằng Chrome/Safari để mượt hơn
  <button id="btnExternal">Mở</button>
</div>

<!-- Media -->
<video id="v" playsinline crossorigin="anonymous"
 src="https://res.cloudinary.com/dj5uo6y8w/video/upload/v1756374279/bac-ho-2-9_pllr7b.mp4"></video>
<audio id="bgm" loop crossorigin="anonymous"
 src="https://res.cloudinary.com/dj5uo6y8w/video/upload/v1756622154/M%C3%A1u_%C4%90%E1%BB%8F_Da_V%C3%A0ng_mp3cut.net_vhw8k0.mp3"></audio>

<canvas id="c"></canvas>
<canvas id="tc"></canvas>

<script>
/* ==== DOM ==== */
const v = document.getElementById('v');
const bgm = document.getElementById('bgm');
const c = document.getElementById('c');
const ctx = c.getContext('2d', { willReadFrequently: true });
const tc = document.getElementById('tc');
const tctx = tc.getContext('2d', { willReadFrequently: true });

const asciiWrap = document.getElementById('asciiWrap');
const out = document.getElementById('out');
const countdownWrap = document.getElementById('countdownWrap');
const countdown = document.getElementById('countdown');
const textSlide = document.getElementById('textSlide');
const slideBg = document.getElementById('slideBg');
const slideOverlay = document.getElementById('slideOverlay');
const slideText = document.getElementById('slideText');
const fsBtn = document.getElementById('fsBtn');
const unmute = document.getElementById('unmute');
const btnUnmute = document.getElementById('btnUnmute');
const openExternal = document.getElementById('openExternal');
const btnExternal = document.getElementById('btnExternal');

/* ==== DETECT & MODES ==== */
const UA = navigator.userAgent || "";
const isZalo = /Zalo/i.test(UA);
const isIOS = /iPhone|iPad|iPod/i.test(UA);
const isAndroid = /Android/i.test(UA);

/* LITE mode: cho Zalo WebView, màn dọc, máy yếu… */
const SMALL_SCREEN = Math.min(window.innerWidth, window.innerHeight) <= 480;
const LOW_POWER = isZalo || SMALL_SCREEN;
const MAX_FPS = LOW_POWER ? 10 : 20;          // hạ FPS để nhẹ CPU + RAM
let COLORIZE_VIDEO = false;                   // tắt tô màu từng ký tự (tiết kiệm cực mạnh)
let COLORIZE_ASCII_SLIDE = false;             // chữ/ảnh ASCII cũng không tô màu

/* ==== CONFIG ==== */
const gradientChars = "  .,:;clodxk0KXN";  // ngắn hơn để tính nhanh
let asciiRows = 0;

const FLAG_IMG_SRC = "https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436052/hinh-nen-co-viet-nam-cho-may-tinh-1_hlcqkj.jpg";
let flagImg = new Image(), flagReady = false;
flagImg.crossOrigin = "anonymous";
flagImg.onload = ()=> flagReady = true;
flagImg.src = FLAG_IMG_SRC;

/* Utils */
function vw(){ return window.innerWidth }
function vh(){ return window.innerHeight }
function getCols(){
  // ít cột hơn trong LITE/portrait -> tiết kiệm RAM rất nhiều
  const w = vw();
  if (LOW_POWER) {
    if (w <= 360) return 72;
    if (w <= 420) return 88;
    if (w <= 640) return 110;
    return 130;
  } else {
    if (w <= 640) return 100;
    if (w <= 820) return 130;
    if (w <= 1024) return 150;
    if (w <= 1366) return 180;
    return 200;
  }
}
function lum(r,g,b){ return (0.299*r + 0.587*g + 0.114*b)/255; }

/* Mở ngoài trình duyệt (banner nhẹ, không chặn) */
function openInExternalBrowser(){
  const url = window.location.href;
  const a = document.createElement('a');
  a.href = url; a.target = '_blank'; a.rel = 'noopener';
  document.body.appendChild(a); a.click(); a.remove();
  if (isAndroid) {
    const intent = 'intent://' + url.replace(/^https?:\/\//,'') + '#Intent;scheme=https;package=com.android.chrome;end';
    setTimeout(()=>{ window.location.href = intent; }, 120);
  }
  if (isIOS) {
    setTimeout(()=>{ window.open(url, '_blank'); }, 100);
  }
}

/* Fit + Cover để luôn FULL màn hình */
function setAsciiSize(){
  if(asciiRows===0) return;
  const cols = getCols();
  const fsW = vw() / cols;
  const fsH = vh() / asciiRows;
  const baseFS = Math.min(fsW, fsH);
  const baseW = cols * baseFS;
  const baseH = asciiRows * baseFS;
  const scale = Math.max(vw()/baseW, vh()/baseH);
  out.style.fontSize = baseFS + "px";
  out.style.lineHeight = baseFS + "px";
  out.style.transform = `scale(${scale})`;
}

/* ===== VIDEO → ASCII (mono, textContent để tiết kiệm RAM) ===== */
function toAsciiFrame_Video_Text(){
  if(!v.videoWidth) return "";
  const cols = getCols();
  const targetW = cols;
  const targetH = Math.max(1, Math.round((v.videoHeight / v.videoWidth) * targetW * 0.55));
  c.width = targetW; c.height = targetH;
  ctx.drawImage(v, 0, 0, targetW, targetH);

  const data = ctx.getImageData(0,0,targetW,targetH).data;
  asciiRows = targetH;
  const maxIdx = gradientChars.length - 1;
  const lines = new Array(targetH);

  for(let y=0;y<targetH;y++){
    let row = "";
    let rowOffset = y*targetW*4;
    for(let x=0;x<targetW;x++){
      const i = rowOffset + (x<<2);
      const L = lum(data[i], data[i+1], data[i+2]);
      const idx = (L<=0)?0 : (L>=1)?maxIdx : (L*maxIdx)|0;
      row += gradientChars[idx];
    }
    lines[y] = row;
  }
  return lines.join("\n");
}

/* ===== TEXT/FLAG SLIDE → ASCII (mono) ===== */
function wrapLinesByWidth(text, maxWidthPx, font){
  tctx.font = font;
  const words = text.split(/\s+/);
  const lines = [];
  let cur = "";
  for(const w of words){
    const test = cur ? cur + " " + w : w;
    if(tctx.measureText(test).width <= maxWidthPx) cur = test;
    else { if(cur) lines.push(cur); cur = w; }
  }
  if(cur) lines.push(cur);
  return lines;
}
function fitFontAndWrap(text, targetW, targetH){
  let fs = Math.max(14, Math.round(targetH * 0.42));
  let font = `900 ${fs}px "Times New Roman", serif`;
  let lines = wrapLinesByWidth(text, targetW*0.9, font);
  function totalH(fsize, lineCount){ return lineCount * fsize * 1.1; }
  while ((lines.length > 2 || totalH(fs, lines.length) > targetH*0.88) && fs > 10){
    fs -= 2;
    font = `900 ${fs}px "Times New Roman", serif`;
    lines = wrapLinesByWidth(text, targetW*0.9, font);
  }
  return { fs, font, lines };
}
function drawFlagAndTextASCII_mono(text, t, duration){
  const cols = getCols();
  tc.width = cols;
  tc.height = Math.max(28, Math.round(cols * 0.30));
  const W = tc.width, H = tc.height;

  // nền (grayscale nhanh)
  tctx.clearRect(0,0,W,H);
  if(flagReady){
    let ratio = flagImg.width/flagImg.height || 1.6;
    let dw = W, dh = W/ratio;
    if(dh < H){ dh = H; dw = dh*ratio; }
    const dx = (W - dw)/2, dy = (H - dh)/2;
    tctx.drawImage(flagImg, dx, dy, dw, dh);
  } else {
    tctx.fillStyle = "#111"; tctx.fillRect(0,0,W,H);
  }

  // chữ trắng có viền đen mỏng
  let {fs, font, lines} = fitFontAndWrap(text, W, H);
  tctx.font = font; tctx.textAlign = 'center'; tctx.textBaseline = 'middle';
  const p = Math.max(0, Math.min(1, t/duration));
  const scale = 0.92 + 0.08*Math.sin(p*Math.PI);
  tctx.save(); tctx.translate(W/2, H/2); tctx.scale(scale, scale);
  const totalH = lines.length * fs * 1.1; let y0 = -totalH/2 + fs*0.5;
  for(const line of lines){
    tctx.lineWidth = Math.max(1, fs*0.06);
    tctx.strokeStyle = 'rgba(0,0,0,0.9)';
    tctx.strokeText(line, 0, y0);
    tctx.fillStyle = '#fff';
    tctx.fillText(line, 0, y0);
    y0 += fs*1.1;
  }
  tctx.restore();

  // canvas → ASCII (mono, textContent)
  const data = tctx.getImageData(0,0,W,H).data;
  asciiRows = H; const maxIdx = gradientChars.length - 1;
  const linesOut = new Array(H);
  for(let yy=0; yy<H; yy++){
    let row = "";
    let rowOff = yy*W*4;
    for(let xx=0; xx<W; xx++){
      const i = rowOff + (xx<<2), a = data[i+3];
      if(a < 20){ row += ' '; continue; }
      const L = lum(data[i], data[i+1], data[i+2]);
      const idx = (L<=0)?0 : (L>=1)?maxIdx : (L*maxIdx)|0;
      row += gradientChars[idx];
    }
    linesOut[yy] = row;
  }
  return linesOut.join("\n");
}

/* ===== FLOW: VIDEO → SLIDES (nhẹ) ===== */
function playAsciiVideoThenSlides(){
  asciiWrap.style.display = "grid";
  setAsciiSize();

  // Thử phát video có âm thanh
  v.muted = false; v.volume = 1;
  v.play().then(()=>{
    unmute.style.display = 'none';
    startVideoLoop();
  }).catch(()=>{
    v.muted = true;
    v.play().then(()=>{
      unmute.style.display = 'grid';
      startVideoLoop();
    }).catch(err=>console.error("Không thể phát video:", err));
  });

  btnUnmute.onclick = ()=>{
    v.muted = false;
    v.play().catch(()=>{});
    bgm.play().catch(()=>{});
    unmute.style.display = 'none';
  };

  function startVideoLoop(){
    let done = false;
    let last = performance.now();
    const frameInterval = 1000 / MAX_FPS;

    function loop(now){
      if(v.ended || v.paused){
        if(!done){ done = true; startFlagSlides(); }
        return;
      }
      const dt = now - last;
      if (dt >= frameInterval){
        last = now;
        // dùng textContent để giảm tạo DOM nodes
        out.textContent = toAsciiFrame_Video_Text();
        setAsciiSize();
      }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  }
}

/* ===== SLIDES LIST ===== */
const asciiSlides = [
  "Tự hào màu cờ sắc áo",
  "VietinBank đồng hành",
  "cùng Tổ quốc vươn xa –",
  "giữ vững niềm tin, lan",
  "tỏa khát vọng, chung tay",
  "dựng xây đất nước phồn",
  "vinh, vì một Việt Nam",
  "ngày càng thịnh vượng, văn",
  "minh và tỏa sáng trên",
  "trường quốc tế."
];

/* ===== ASCII SLIDES (mượt & nhẹ) ===== */
function startFlagSlides(){
  bgm.volume = 1;
  bgm.play().catch(()=>{});

  let idx = 0;
  const D = LOW_POWER ? 1600 : 2000; // slide nhanh hơn chút ở LITE
  const GAP = 0;
  function playOne(){
    if(idx >= asciiSlides.length){
      startAsciiImages(asciiImages, { duration: LOW_POWER ? 2000 : 2600, gap: 0, loop: true });
      return;
    }
    const text = asciiSlides[idx++];
    const t0 = performance.now();
    function loop(){
      const t = performance.now() - t0;
      const p = Math.max(0, Math.min(1, t / D));
      // fade in/out
      let op = 1; if(p < 0.12) op = p/0.12; else if(p > 0.88) op = (1-p)/0.12;
      out.style.opacity = Math.max(0, Math.min(1, op));
      out.textContent = drawFlagAndTextASCII_mono(text, t, D);
      setAsciiSize();
      if(t < D){ requestAnimationFrame(loop); }
      else { out.style.opacity = 0; setTimeout(playOne, GAP); }
    }
    out.style.opacity = 0;
    requestAnimationFrame(loop);
  }
  playOne();
}

/* ===== COUNTDOWN & INTRO SLIDES ===== */
function runCountdown(next){
  const steps=["3","2","1"]; let i=0;
  countdownWrap.style.display='grid';
  const tick=()=>{
    if(i<steps.length){
      countdown.textContent=steps[i++];
      countdown.style.animation='none'; void countdown.offsetWidth;
      countdown.style.animation='pulse 1.1s ease both';
      setTimeout(tick, 900);
    }else{
      countdownWrap.style.display='none';
      next && next();
    }
  }; tick();
}
const BG_BLUE="https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436137/3654dadd-589c-49de-8241-1748d8ef4a69_yx4mjg.webp";
const BG_FLAG="https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436056/hinh-nen-co-viet-nam-cho-may-tinh-1_wwoocv.jpg";
function showSlides(slides, done){
  let idx=0;
  textSlide.style.opacity = 0;
  textSlide.style.transition = 'opacity 250ms ease';
  const showOne=()=>{
    if(idx>=slides.length){
      textSlide.style.display='none';
      done && done();
      return;
    }
    const s = slides[idx++];
    slideBg.style.backgroundImage = `url('${s.bgImage}')`;
    slideOverlay.style.background = s.overlay;
    slideText.textContent = s.text;
    slideText.style.color = s.color;

    textSlide.style.display = 'flex';
    requestAnimationFrame(()=> textSlide.style.opacity = 1);
    setTimeout(()=>{
      textSlide.style.opacity = 0;
      setTimeout(showOne, 40);
    }, s.duration);
  };
  showOne();
}

/* FULLSCREEN (tuỳ chọn) */
function isFullscreen(){ return !!(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement); }
function enterFullscreen(el){ const req = el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen; if(req) req.call(el); }
fsBtn.addEventListener('click', ()=> enterFullscreen(document.documentElement));
document.addEventListener('fullscreenchange', ()=> fsBtn.style.display = isFullscreen()? 'none' : 'block');
document.addEventListener('webkitfullscreenchange', ()=> fsBtn.style.display = isFullscreen()? 'none' : 'block');

/* === ASCII IMAGE ALBUM (mono, nhẹ) === */
const asciiImages = [
  "https://res.cloudinary.com/dj5uo6y8w/image/upload/w_300/v1756625496/t%E1%BA%A3i_xu%E1%BB%91ng_1_l2j7vg.jpg",
  "https://res.cloudinary.com/dj5uo6y8w/image/upload/w_300/v1756625496/t%E1%BA%A3i_xu%E1%BB%91ng_2_rrqetv.jpg",
  "https://res.cloudinary.com/dj5uo6y8w/image/upload/w_300/v1756625495/Ho_Hoan_Kiem_Hanoi_Vietnam__Stock_Photo_-_Image_of_flag_temple__5825156_ey7vcj.jpg",
];
function imgToAsciiText(img){
  const W = getCols(), H = Math.round(W * 0.55);
  tc.width = W; tc.height = H; tctx.clearRect(0,0,W,H);
  const r = img.width / img.height || 1.6;
  let dw = W, dh = W / r; if(dh < H){ dh = H; dw = dh * r; }
  const dx = (W - dw)/2, dy = (H - dh)/2;
  tctx.drawImage(img, dx, dy, dw, dh);

  const data = tctx.getImageData(0,0,W,H).data, max = gradientChars.length - 1;
  asciiRows = H;
  const lines = new Array(H);
  for(let y=0;y<H;y++){
    let row = ""; let off = y*W*4;
    for(let x=0;x<W;x++){
      const i = off + (x<<2), a = data[i+3];
      if(a < 20){ row += " "; continue; }
      const L = lum(data[i], data[i+1], data[i+2]);
      const idx = (L<=0)?0 : (L>=1)?max : (L*max)|0;
      row += gradientChars[idx];
    }
    lines[y] = row;
  }
  return lines.join("\n");
}
function startAsciiImages(links, {duration=2200, gap=0, loop=true} = {}){
  let i = 0, stop = false;
  (function next(){
    if(stop || !links.length) return;
    const src = links[i % links.length], img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      const t0 = performance.now();
      (function frame(){
        const t = performance.now() - t0, p = Math.max(0, Math.min(1, t/duration));
        let op = 1; if(p < .12) op = p/.12; else if(p > .88) op = (1-p)/.12;
        out.style.opacity = op;
        out.textContent = imgToAsciiText(img);
        setAsciiSize();
        if(t < duration) requestAnimationFrame(frame);
        else { out.style.opacity = 0; i++; setTimeout(()=>{ next(); }, gap); }
      })();
    };
    img.onerror = () => { i++; next(); };
    img.src = src;
  })();
  return () => { stop = true; };
}

/* ===== START ===== */
function startAll(){
  // Zalo: chỉ hiển thị banner gợi ý (không chặn)
  if (isZalo) {
    openExternal.style.display = 'block';
  }

  fsBtn.style.display = LOW_POWER ? 'none' : 'block'; // ẩn trên webview

  const slides = [
    { text: "PHÒNG DỊCH VỤ KHÁCH HÀNG", bgImage: "https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436137/3654dadd-589c-49de-8241-1748d8ef4a69_yx4mjg.webp", overlay: "linear-gradient(180deg, rgba(0,114,188,.55), rgba(0,114,188,.55))", color: "#ffffff", duration: 1500 },
    { text: "VIETINBANK",                 bgImage: "https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436137/3654dadd-589c-49de-8241-1748d8ef4a69_yx4mjg.webp", overlay: "linear-gradient(180deg, rgba(0,114,188,.55), rgba(0,114,188,.55))", color: "#ffffff", duration: 1300 },
    { text: "CHI NHÁNH BẢO LỘC",          bgImage: "https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436137/3654dadd-589c-49de-8241-1748d8ef4a69_yx4mjg.webp", overlay: "linear-gradient(180deg, rgba(0,114,188,.55), rgba(0,114,188,.55))", color: "#ffffff", duration: 1700 },
    { text: "CHÚC MỪNG",                  bgImage: "https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436056/hinh-nen-co-viet-nam-cho-may-tinh-1_wwoocv.jpg",       overlay: "linear-gradient(180deg, rgba(218,37,29,.45), rgba(218,37,29,.45))", color: "#ffeded", duration: 1300 },
    { text: "ĐẠI LỄ 2/9",                 bgImage: "https://res.cloudinary.com/dj5uo6y8w/image/upload/v1756436056/hinh-nen-co-viet-nam-cho-may-tinh-1_wwoocv.jpg",       overlay: "linear-gradient(180deg, rgba(218,37,29,.45), rgba(218,37,29,.45))", color: "#ffeded", duration: 1800 },
  ];

  runCountdown(()=> showSlides(slides, ()=> {
    asciiWrap.style.display='grid';
    playAsciiVideoThenSlides();
  }));
}

window.addEventListener('resize', setAsciiSize);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setAsciiSize(); });
btnExternal.addEventListener('click', openInExternalBrowser);

window.addEventListener('load', startAll);
</script>
</body>
</html>
